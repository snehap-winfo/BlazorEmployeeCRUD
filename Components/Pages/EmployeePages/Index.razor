 @page "/employees"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorEmployeeCRUD.Models
@using BlazorEmployeeCRUD.Data
@implements IAsyncDisposable
@inject IDbContextFactory<BlazorEmployeeCRUD.Data.AppDBContext> DbFactory

<PageTitle>Index</PageTitle>

<h1>Index</h1>
<div>
    <input type="number" @bind="SearchID" @bind:event="oninput" placeholder="Enter Id" />
    <button class="btn btn-outline-primary" @onclick="OnSearch">Search</button>
    <button class="btn btn-outline-secondary" @onclick="LoadAll">Reset</button>
</div>




@* <a href="/employees/search">Search Employee</a> *@

<p>
    <a href="employees/create">Create New</a>
</p>

@if(employees !=null && employees.Any())
{
<QuickGrid Class="table" TGridItem="Employee" Items="employees.AsQueryable()">
    <PropertyColumn Property="@(employee => employee.Id)" Title="Id" />
    <PropertyColumn Property="@(employee => employee.Name)" Title="Name" />
    <PropertyColumn Property="@(employee => employee.Position)" Title="Position" />
    <PropertyColumn Property="@(employee => employee.DOB)" Title="DOB" />

    <TemplateColumn Context="employee">
        <a class="btn btn-primary" href="@($"employees/edit?id={employee.Id}")">Edit</a> 
        <a class="btn btn-secondary" href="@($"employees/details?id={employee.Id}")">Details</a> 
        <a class="btn btn-danger"href="@($"employees/delete?id={employee.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>
}
else
{
    <p>No Record found</p>
}

@code {
    private AppDBContext context = default!;
    private List<Employee> employees = new();

    

    private int? SearchID { get; set; } = 0;

    private IEnumerable<Employee> FilteredEmployees =>
        employees.Where(e => e.Status && (!SearchID.HasValue || e.Id == SearchID.Value));

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        await LoadAll();
    }

    private async Task OnSearch()
    {
        Console.WriteLine($"Searching for ID: {SearchID}");
        if (SearchID > 0)
        {
            // Use a new context from factory
            await using var searchContext = DbFactory.CreateDbContext();

            employees = await searchContext.Employee
                .Where(e => e.Id == SearchID&&e.Status==true)
                .ToListAsync();
        }
        else
        {
            employees.Clear();
        }

        StateHasChanged();
    }

    private async Task LoadAll()
    {
        await using var loadContext = DbFactory.CreateDbContext();
        employees = await loadContext.Employee.Where(e=>e.Status==true).ToListAsync();
        StateHasChanged();
    }


    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}




